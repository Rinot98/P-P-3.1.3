<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>
    <div th:replace="fragments :: bootstrap-css"></div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
</head>

<body>

<nav class="navbar navbar-dark bg-dark px-3">
    <div class="container-fluid">
        <!-- Левая часть -->
        <span class="text-light me-3 fs-5">
                <span style="font-weight: bold;" th:text="${#authentication.name}">admin@mail.ru</span>
                with roles:
                <span th:each="role, stat : ${user.roles}">
                    <span th:text="${role.role}">Roles</span>
                    <span th:if="${!stat.last}">, </span>
                </span>
            </span>

        <!-- Правая часть -->
        <div class="d-flex align-items-center">
            <form th:action="@{/logout}" method="post" class="m-0">
                <button type="submit" class="btn p-0 border-0 text-white text-decoration-none">
                    Logout
                </button>
            </form>
        </div>
    </div>
</nav>

<div class="container-fluid mt-3">
    <div class="row">
        <!-- Левая колонка - переключение роли (высота во всю страницу) -->
        <div class="col-lg-3 col-md-4">
            <div class="card-body">
                <!-- Переключение ролей -->
                <div class="mb-4">
                    <div class="list-group">
                            <span th:each="role, stat : ${user.roles}">
                                <button th:if="${role.role == 'ADMIN'}"
                                        class="list-group-item list-group-item-action role-btn"
                                        data-role="ADMIN"
                                        th:onclick="'window.location.href = \'' + @{/admin/profile} + '\''">
                                    <i class="bi bi-shield-check me-2"></i>ADMIN
                                </button>
                                <button th:if="${role.role == 'USER'}"
                                        class="list-group-item list-group-item-action role-btn"
                                        data-role="USER"
                                        th:onclick="'window.location.href = \'' + @{/user} + '\''">
                                    <i class="bi bi-person me-2"></i>USER
                                </button>
                                <button th:if="${role.role != 'USER' && role.role != 'ADMIN'}"
                                        class="list-group-item list-group-item-action role-btn"
                                        th:attr="data-role=${role.role}"
                                        th:onclick="'window.location.href = \'' + @{/user} + '\''">
                                    <i class="bi bi-gear me-2"></i>
                                    <span th:text="${role.role}">Roles</span>
                                </button>
                            </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Правая колонка - таблица и кнопки -->
        <div class="col-lg-9 col-md-8">
            <!-- Заголовок и кнопки -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Admin panel</h2>
            </div>

            <!-- Контейнер для контента -->
            <div id="contentArea">
                <!-- Табы -->
                <ul class="nav nav-tabs mb-3" id="usersTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="table-tab" data-bs-toggle="tab"
                                data-bs-target="#table-pane" type="button" role="tab">
                            <i class="bi bi-table"></i> Users table
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="form-tab" data-bs-toggle="tab"
                                data-bs-target="#form-pane" type="button" role="tab">
                            <i class="bi bi-plus-circle"></i> New User
                        </button>
                    </li>
                </ul>
                <!-- Контейнер для контента табов -->
                <div class="tab-content" id="usersTabContent">
                    <!-- Таб с таблицей пользователей -->
                    <div class="tab-pane fade show active" id="table-pane" role="tabpanel">
                        <!-- Таблица пользователей -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">All users</h5>
                                <span class="badge bg-primary" th:text="'Total: ' + ${users.size()} + ' users'">Total users</span>
                            </div>
                            <div class="card-body p-3">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>First Name</th>
                                            <th>Last Name</th>
                                            <th>Age</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Edit</th>
                                            <th>Delete</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="user : ${users}">
                                            <td th:text="${user.getId()}">ID</td>
                                            <td th:text="${user.name}">Name</td>
                                            <td th:text="${user.surname}">Surname</td>
                                            <td th:text="${user.age}">Age</td>
                                            <td th:text="${user.email}">Email</td>
                                            <td>
                                    <span th:each="role, stat : ${user.roles}">
                                    <span th:if="${role.role == 'ADMIN'}" class="badge bg-danger me-1">ADMIN</span>
                                    <span th:if="${role.role != 'ADMIN'}" class="badge bg-success me-1"
                                          th:text="${role.role}">Roles</span>
                                    </span>
                                            <td>
                                                <button class="btn btn-warning btn-sm"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#userEditModal"
                                                        th:data-user-id="${user.id}"
                                                        th:data-user-firstname="${user.name}"
                                                        th:data-user-lastname="${user.surname }"
                                                        th:data-user-age="${user.age}"
                                                        th:data-user-email="${user.email}"
                                                        th:data-user-phonenumber="${user.phoneNumber}"
                                                        th:data-user-roles="${#strings.listJoin(user.roles.![role], ',')}">
                                                    <i class="bi bi-pencil"></i> Edit
                                                </button>
                                            </td>
                                            <td>
                                                <button class="btn btn-danger btn-sm"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#userDeleteModal"
                                                        th:data-user-id="${user.id}"
                                                        th:data-user-firstname="${user.name}"
                                                        th:data-user-lastname="${user.surname}"
                                                        th:data-user-age="${user.age}"
                                                        th:data-user-email="${user.email}"
                                                        th:data-user-phonenumber="${user.phoneNumber}"
                                                        th:data-user-roles="${#strings.listJoin(user.roles.![role], ',')}">
                                                    <i class="bi bi-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Таб с формой для добавления пользователя -->
                    <div class="tab-pane fade" id="form-pane" role="tabpanel">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0 fw-bold">Create new user</h5>
                                </div>
                                <div class="card-body text-center d-block">
                                    <div class="row justify-content-center">
                                        <div class="col-md-8 col-lg-6 mx-auto" style="max-width: 300px;">
                                            <!-- Регистрационная форма -->
                                            <form th:action="@{/admin/save}" th:object="${newUser}" method="post">
                                                <input type="hidden" th:field="*{id}" value="0"/>
                                                <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
                                                <!-- Name -->
                                                <div class="mb-3">
                                                    <label for="name" class="form-label fw-bold">First name *</label>
                                                    <input type="text" class="form-control" id="name" th:field="*{name}"
                                                           placeholder="Enter first name" required>
                                                </div>
                                                <!-- Surname -->
                                                <div class="mb-3">
                                                    <label for="surname" class="form-label fw-bold">Surname</label>
                                                    <input type="text" class="form-control" id="surname"
                                                           th:field="*{surname}" placeholder="Enter surname">
                                                </div>
                                                <!-- Age -->
                                                <div class="mb-3">
                                                    <label for="age" class="form-label fw-bold">Age *</label>
                                                    <input type="number" class="form-control" id="age"
                                                           min="18" max="100" th:field="*{age}" placeholder="Enter age"
                                                           required>
                                                </div>
                                                <!-- Email -->
                                                <div class="mb-3">
                                                    <label for="email" class="form-label fw-bold">E-mail *</label>
                                                    <input type="email" class="form-control" id="email"
                                                           th:field="*{email}" placeholder="Enter E-mail" required>
                                                </div>
                                                <!-- Password -->
                                                <div class="mb-3">
                                                    <label for="password" class="form-label fw-bold">Password *</label>
                                                    <input type="password" class="form-control" id="password"
                                                           th:field="*{password}" placeholder="Enter password" required>
                                                </div>
                                                <!-- Roles -->
                                                <div class="mb-3">
                                                    <label for="userRoles" class="form-label fw-bold">Roles *</label>

                                                    <select class="form-control" id="userRoles" name="roles"
                                                            multiple size="2" th:field="*{roles}"
                                                            style="overflow-y: scroll;">
                                                        <option th:each="role : ${allRoles}"
                                                                th:value="${role.role}"
                                                                th:text="${role.role}"
                                                                th:selected="${#lists.contains(newUser.roles, role)}">
                                                            ADMIN
                                                        </option>
                                                    </select>
                                                    <div class="form-text">
                                                        Hold Ctrl/Cmd to select multiple roles
                                                    </div>
                                                </div>
                                                <div class="d-flex gap-2 justify-content-center">
                                                    <button type="submit" class="btn btn-success ">
                                                        <i class="bi bi-plus-circle"></i> Create User
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Модальное окно с вашей формой для редактирования пользователя -->
                    <div class="modal fade" id="userEditModal" tabindex="-1" aria-labelledby="userEditModalLabel"
                         aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <!-- Заголовок -->
                                <div class="modal-header">
                                    <h5 class="modal-title" id="userEditModalLabel">Edit User</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <!-- Тело с вашей формой -->
                                <div class="modal-body">
                                    <form id="userEditForm" method="post" class="mx-auto" style="max-width: 300px;">
                                        <input type="hidden" id="editUserId" name="id"/>
                                        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
                                        <input type="hidden" name="_method" value="PUT"/>
                                        <!-- ID -->
                                        <div class="mb-3">
                                            <label for="displayUserId"
                                                   class="form-label fw-bold text-center d-block">ID</label>
                                            <input type="text" class="form-control bg-dark bg-opacity-10 text-muted"
                                                   id="displayUserId" disabled readonly>
                                        </div>
                                        <!-- Name -->
                                        <div class="mb-3">
                                            <label for="editName" class="form-label fw-bold text-center d-block">First
                                                name *</label>
                                            <input type="text" class="form-control" id="editName" name="name" required>
                                        </div>
                                        <!-- Surname -->
                                        <div class="mb-3">
                                            <label for="editSurname" class="form-label fw-bold text-center d-block">Surname</label>
                                            <input type="text" class="form-control" id="editSurname" name="surname">
                                        </div>
                                        <!-- Age -->
                                        <div class="mb-3">
                                            <label for="editAge" class="form-label fw-bold text-center d-block">Age
                                                *</label>
                                            <input type="number" class="form-control" id="editAge" name="age"
                                                   min="18" max="100" required>
                                        </div>
                                        <!-- Email -->
                                        <div class="mb-3">
                                            <label for="editEmail" class="form-label fw-bold text-center d-block">E-mail
                                                *</label>
                                            <input type="email" class="form-control" id="editEmail" name="email"
                                                   required>
                                        </div>
                                        <!-- Password -->
                                        <div class="mb-3">
                                            <label for="editPassword" class="form-label fw-bold text-center d-block">Password
                                                *</label>
                                            <input type="password" class="form-control" id="editPassword"
                                                   name="password">
                                            <p>
                                                <small class="form-text text-muted">Leave empty to keep current
                                                    password</small>
                                            </p>
                                        </div>
                                        <!-- Roles -->
                                        <div class="mb-3">
                                            <label for="editRoles" class="form-label fw-bold text-center d-block">Roles
                                                *</label>
                                            <select class="form-control" id="editRoles" name="roles"
                                                    multiple size="2" style="overflow-y: scroll;" required>
                                                <option th:each="role : ${allRoles}"
                                                        th:value="${role.role}"
                                                        th:text="${role.role}"
                                                        th:selected="${#lists.contains(newUser.roles, role)}">
                                                    ADMIN
                                                </option>
                                            </select>
                                            <div class="form-text">
                                                Hold Ctrl/Cmd to select multiple roles
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <!-- Футер с кнопками -->
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel
                                    </button>
                                    <button type="submit" class="btn btn-primary" form="userEditForm">Edit User</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Модальное окно с формой для удаления пользователя -->
                    <div class="modal fade" id="userDeleteModal" tabindex="-1" aria-labelledby="userDeleteModalLabel"
                         aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="userDeleteModalLabel">Delete user</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>

                                <div class="modal-body">
                                    <!-- Форма для удаления -->
                                    <form id="userDeleteForm" method="post" class="mx-auto" style="max-width: 300px;">
                                        <input type="hidden" id="deleteFormUserId" name="id"/>
                                        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
                                        <input type="hidden" name="_method" value="DELETE"/>
                                        <!-- ID -->
                                        <div class="mb-3">
                                            <label for="deleteUserId"
                                                   class="form-label fw-bold text-center d-block">ID</label>
                                            <input type="text" class="form-control bg-dark bg-opacity-10 text-muted"
                                                   id="deleteUserId" disabled readonly>
                                        </div>
                                        <!-- Name -->
                                        <div class="mb-3">
                                            <label for="deleteUserName" class="form-label fw-bold text-center d-block">First
                                                name</label>
                                            <input type="text" class="form-control bg-dark bg-opacity-10 text-muted"
                                                   id="deleteUserName" disabled readonly>
                                        </div>
                                        <!-- Surname -->
                                        <div class="mb-3">
                                            <label for="deleteUserSurname"
                                                   class="form-label fw-bold text-center d-block">Surname</label>
                                            <input type="text" class="form-control bg-dark bg-opacity-10 text-muted"
                                                   id="deleteUserSurname" disabled readonly>
                                        </div>
                                        <!-- Age -->
                                        <div class="mb-3">
                                            <label for="deleteUserAge" class="form-label fw-bold text-center d-block">Age</label>
                                            <input type="text" class="form-control bg-dark bg-opacity-10 text-muted"
                                                   id="deleteUserAge" disabled readonly>
                                        </div>
                                        <!-- Email -->
                                        <div class="mb-3">
                                            <label for="deleteUserEmail" class="form-label fw-bold text-center d-block">E-mail</label>
                                            <input type="text" class="form-control bg-dark bg-opacity-10 text-muted"
                                                   id="deleteUserEmail" disabled readonly>
                                        </div>
                                        <!-- Roles -->
                                        <div class="mb-3">
                                            <label class="form-label fw-bold text-center d-block">Roles</label>
                                            <div class="form-control bg-dark bg-opacity-10 text-muted"
                                                 style="min-height: 40px; overflow-y: scroll;"
                                                 id="deleteUserRoles">
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <!-- Футер с кнопками -->
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-arrow-left"></i> Back
                                    </button>
                                    <button type="submit" class="btn btn-danger" form="userDeleteForm">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div th:replace="fragments :: jquery"></div>
<div th:replace="fragments :: bootstrap-js"></div>

<script>
    // Функции переключения между таблицей и формой
    function showUsersTable() {
        document.getElementById('usersTableSection').style.display = 'block';
        document.getElementById('userFormSection').style.display = 'none';
    }

    function showUserForm() {
        document.getElementById('usersTableSection').style.display = 'none';
        document.getElementById('userFormSection').style.display = 'block';
    }

    // По умолчанию показываем таблицу
    document.addEventListener('DOMContentLoaded', function () {
        showUsersTable();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

<script>
    // Инициализация selectpicker
    document.addEventListener('DOMContentLoaded', function () {
        $('.selectpicker').selectpicker();

        // Обновление при изменении
        $('#userRoles').on('changed.bs.select', function (e) {
            console.log('Selected roles:', $(this).val());
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const userEditModal = document.getElementById('userEditModal');
        const userDeleteModal = document.getElementById('userDeleteModal');

        // Обработчик для модального окна редактирования
        userEditModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            fillUserData(button, 'edit');

            // Обновляем action формы
            const userId = button.getAttribute('data-user-id');
            const form = document.getElementById('userEditForm');
            form.action = `/admin/update/${userId}`;
        });

        // Обработчик для модального окна удаления
        userDeleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            fillUserData(button, 'delete');

            // Обновляем action формы
            const userId = button.getAttribute('data-user-id');
            const form = document.getElementById('userDeleteForm');
            form.action = `/admin/delete/${userId}`;
        });

        // Общая функция для заполнения данных
        function fillUserData(button, mode) {
            const userId = button.getAttribute('data-user-id');
            const userName = button.getAttribute('data-user-firstname');
            const userSurname = button.getAttribute('data-user-lastname');
            const userAge = button.getAttribute('data-user-age');
            const userEmail = button.getAttribute('data-user-email');
            const userRoles = button.getAttribute('data-user-roles');

            if (mode === 'edit') {
                // Заполняем форму редактирования
                document.getElementById('displayUserId').value = userId;
                document.getElementById('editUserId').value = userId;
                document.getElementById('editName').value = userName;
                document.getElementById('editSurname').value = userSurname;
                document.getElementById('editAge').value = userAge;
                document.getElementById('editEmail').value = userEmail;

            } else if (mode === 'delete') {
                // Заполняем информацию для подтверждения удаления
                document.getElementById('deleteFormUserId').value = userId;
                document.getElementById('deleteUserId').value = userId;
                document.getElementById('deleteUserName').value = userName;
                document.getElementById('deleteUserSurname').value = userSurname;
                document.getElementById('deleteUserAge').value = userAge;
                document.getElementById('deleteUserEmail').value = userEmail;
                document.getElementById('deleteUserRoles').value = userRoles.split(',').join('\n');

                const rolesContainer = document.getElementById('deleteUserRoles');
                const rolesArray = userRoles.split(',');
                rolesContainer.innerHTML = '';

                rolesArray.forEach(role => {
                    const badgeWrapper = document.createElement('div'); // обёртка для каждой роли
                    const badge = document.createElement('span');
                    badge.textContent = role.trim();
                    badgeWrapper.appendChild(badge);
                    rolesContainer.appendChild(badgeWrapper);
                });
            }
        }

        // Сброс при закрытии
        userEditModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('userEditForm').reset();
            $('#editRoles').selectpicker('val', []);
        });

        userDeleteModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('userDeleteForm').reset();
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const roleButtons = document.querySelectorAll('.role-btn');

        // Восстанавливаем активную роль
        const savedRole = localStorage.getItem('activeRole');
        if (savedRole) {
            const activeBtn = document.querySelector(`[data-role="${savedRole}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        } else if (roleButtons.length > 0) {
            roleButtons[0].classList.add('active');
        }

        // Обработчики кликов
        roleButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const role = this.getAttribute('data-role');
                localStorage.setItem('activeRole', role);
                roleButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ageInput = document.getElementById('age');
        if (ageInput && ageInput.value === '0') {
            ageInput.value = '';
        }
    });
</script>
</body>
</html>
